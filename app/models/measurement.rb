# == Schema Information
#
# Table name: measurements
#
#  id                :integer          not null, primary key
#  height            :float
#  weight            :float
#  baby_id           :integer
#  created_at        :datetime         not null
#  updated_at        :datetime         not null
#  happened_at       :datetime
#  height_percentile :integer
#  weight_percentile :integer
#

class Measurement < ActiveRecord::Base
  include ActionView::Helpers
  # Accessible attributes
  # ========================================================
  attr_accessible :height, :weight, :height_percentile, :weight_percentile, :happened_at

  # Validations
  # ========================================================
  validates_presence_of :baby_id
  # validate :height_or_weight - what's this???
  validates :height, presence: { message: "cannot be blank, unless weight is filled out", unless: :weight? }, numericality: { greater_than: 0, less_than_or_equal_to: 36, message: "must be between 0 and 3 feet. This is a baby tracker!", if: :height? }
  validates :weight, presence: { message: "cannot be blank, unless height is filled out", unless: :height? }, numericality: { greater_than: 0, less_than_or_equal_to: 70, message: "must be between 0 and 70 pounds. This is a baby tracker!", if: :weight? }

  # Callbacks
  # ========================================================
  before_save :setHeightPercentile
  before_save :setWeightPercentile

  # Relationships
  # ========================================================
  belongs_to :baby

  # Scopes
  # ========================================================


  # Static functions
  # ========================================================
  def getHeightData(gender)
    if gender.downcase=="male"
      {0=>[44.9251,45.56841,46.55429,48.18937,49.98888,51.77126,53.36153,54.30721,54.919],
      0.5=>[47.97812,48.55809,49.4578,50.97919,52.69598,54.44054,56.03444,56.99908,57.62984],
      1.5=>[52.19859,52.72611,53.55365,54.9791,56.62843,58.35059,59.9664,60.96465,61.62591],
      2.5=>[55.26322,55.77345,56.57772,57.9744,59.60895,61.33788,62.98158,64.00789,64.69241],
      3.5=>[57.73049,58.23744,59.0383,60.43433,62.077,63.82543,65.49858,66.54889,67.2519],
      4.5=>[59.82569,60.33647,61.1441,62.55409,64.21686,65.99131,67.69405,68.76538,69.48354],
      5.5=>[61.66384,62.18261,63.00296,64.43546,66.12531,67.92935,69.66122,70.75128,71.48218],
      6.5=>[63.31224,63.84166,64.67854,66.13896,67.86018,69.69579,71.45609,72.56307,73.30488],
      7.5=>[64.81395,65.35584,66.21181,67.70375,69.45908,71.32735,73.11525,74.23767,74.98899],
      8.5=>[66.19833,66.75398,67.63088,69.15682,70.94804,72.84947,74.6641,75.80074,76.56047],
      9.5=>[67.48635,68.05675,68.95591,70.51761,72.34586,74.2806,76.1211,77.27095,78.03819],
      10.5=>[68.6936,69.27949,70.20192,71.80065,73.66665,75.63462,77.50016,78.66234,79.43637],
      11.5=>[69.832,70.43397,71.38046,73.01712,74.9213,76.92224,78.81202,79.98578,80.76602],
      12.5=>[70.91088,71.52941,72.50055,74.17581,76.11838,78.15196,80.0652,81.2499,82.03585],
      13.5=>[71.9377,72.57318,73.56946,75.2838,77.2648,79.33061,81.2666,82.46167,83.25292],
      14.5=>[72.91853,73.5713,74.59309,76.34685,78.36622,80.4638,82.42185,83.6268,84.42302],
      15.5=>[73.85839,74.52871,75.57634,77.36973,79.42734,81.5562,83.53568,84.75006,85.55095],
      16.5=>[74.76147,75.44958,76.5233,78.35646,80.45209,82.61174,84.61204,85.83547,86.64078],
      17.5=>[75.63132,76.33742,77.43742,79.31042,81.44384,83.63377,85.65431,86.88645,87.69597],
      18.5=>[76.47096,77.19523,78.32168,80.23453,82.40544,84.62515,86.66541,87.90595,88.7195],
      19.5=>[77.283,78.0256,79.17863,81.13131,83.33938,85.58837,87.64786,88.89652,89.71393],
      20.5=>[78.06971,78.83077,80.01048,82.00292,84.24783,86.52562,88.60385,89.86038,90.68153],
      21.5=>[78.83308,79.61271,80.81919,82.85129,85.1327,87.43879,89.53533,90.79951,91.62428],
      22.5=>[79.57485,80.37315,81.60646,83.67811,85.99565,88.32957,90.44402,91.71563,92.54392],
      23.5=>[80.29656,81.11363,82.37381,84.48487,86.83818,89.19948,91.33143,92.61031,93.44203],
      24.5=>[80.99959,81.83552,83.12259,85.2729,87.66161,90.04985,92.19893,93.48491,94.31998],
      25.5=>[81.74464,82.58135,83.87245,86.03703,88.45247,90.8787,93.07143,94.38775,95.24419],
      26.5=>[82.47365,83.31105,84.60576,86.78329,89.22326,91.68468,93.91817,95.263,96.13962],
      27.5=>[83.18812,84.02609,85.32399,87.51317,89.97549,92.46929,94.74064,96.1121,97.00763],
      28.5=>[83.88931,84.72769,86.02833,88.22788,90.71041,93.23385,95.54016,96.93639,97.84957],
      29.5=>[84.57826,85.41688,86.71978,88.9284,91.42908,93.97951,96.318,97.73717,98.66677],
      30.5=>[85.25589,86.09452,87.39917,89.6156,92.13242,94.70732,97.07531,98.51569,99.46052],
      31.5=>[85.92294,86.76134,88.06723,90.2902,92.82127,95.41824,97.81324,99.27318,100.2321],
      32.5=>[86.58009,87.41799,88.72457,90.95287,93.49638,96.11319,98.53287,100.0109,100.9829],
      33.5=>[87.22791,88.06503,89.37177,91.60421,94.15847,96.79307,99.23531,100.73,101.7142],
      34.5=>[87.86696,88.70301,90.00937,92.24482,94.80823,97.45873,99.92162,101.4318,102.4274],
      35.5=>[88.49774,89.33242,90.63786,92.87525,95.44637,98.11108,100.5929,102.1174,103.1237]}
    elsif gender.downcase=="female"
      {0=>[45.09488,45.57561,46.33934,47.68345,49.2864,51.0187,52.7025,53.77291,54.49527],
      0.5=>[47.46916,47.96324,48.74248,50.09686,51.68358,53.36362,54.96222,55.96094,56.62728],
      1.5=>[50.95701,51.47996,52.29627,53.69078,55.28613,56.93136,58.45612,59.38911,60.00338],
      2.5=>[53.62925,54.17907,55.03144,56.47125,58.09382,59.74045,61.24306,62.15166,62.74547],
      3.5=>[55.8594,56.43335,57.31892,58.80346,60.45981,62.1233,63.62648,64.52875,65.11577],
      4.5=>[57.8047,58.40032,59.31633,60.84386,62.5367,64.22507,65.74096,66.64653,67.23398],
      5.5=>[59.54799,60.16323,61.10726,62.6759,64.40633,66.12418,67.65995,68.57452,69.16668],
      6.5=>[61.13893,61.77208,62.7421,64.35005,66.11842,67.8685,69.42868,70.35587,70.95545],
      7.5=>[62.60993,63.25958,64.25389,65.89952,67.70574,69.48975,71.07731,72.01952,72.62835],
      8.5=>[63.98348,64.64845,65.66559,67.34745,69.19124,71.01019,72.62711,73.58601,74.20532],
      9.5=>[65.2759,65.9552,66.99394,68.7107,70.59164,72.44614,74.09378,75.0705,75.70118],
      10.5=>[66.49948,67.19226,68.25154,70.00202,71.91962,73.80997,75.48923,76.4846,77.12729],
      11.5=>[67.66371,68.36925,69.44814,71.23128,73.18501,75.11133,76.82282,77.83742,78.49257],
      12.5=>[68.77613,69.4938,70.59149,72.40633,74.39564,76.35791,78.10202,79.13625,79.80419],
      13.5=>[69.8428,70.57207,71.68784,73.53349,75.55785,77.55594,79.3329,80.38705,81.06801],
      14.5=>[70.86874,71.60911,72.74233,74.61799,76.67686,78.71058,80.5205,81.59475,82.28891],
      15.5=>[71.85807,72.60914,73.75924,75.66416,77.75701,79.82613,81.66903,82.7635,83.47098],
      16.5=>[72.81433,73.57571,74.74217,76.67568,78.80198,80.90623,82.78208,83.89683,84.6177],
      17.5=>[73.74047,74.51184,75.6942,77.65565,79.81492,81.95399,83.86269,84.99774,85.73205],
      18.5=>[74.63908,75.42012,76.61797,78.60678,80.79852,82.97211,84.91353,86.06887,86.81663],
      19.5=>[75.51237,76.30282,77.51576,79.53138,81.75512,83.96292,85.93689,87.11249,87.8737],
      20.5=>[76.36229,77.16191,78.38958,80.4315,82.68679,84.92846,86.93481,88.13061,88.90526],
      21.5=>[77.19056,77.9991,79.2412,81.30893,83.59532,85.87054,87.90908,89.125,89.91305],
      22.5=>[77.99868,78.81595,80.07216,82.16525,84.48233,86.79077,88.86127,90.09723,90.89866],
      23.5=>[78.78801,79.61381,80.88385,83.00187,85.34924,87.69056,89.79282,91.04873,91.86347],
      24.5=>[79.55974,80.39391,81.67752,83.82007,86.19732,88.57121,90.70499,91.98074,92.80876],
      25.5=>[80.33998,81.18804,82.49318,84.67209,87.09026,89.50562,91.67718,92.97574,93.81864],
      26.5=>[81.11332,81.97223,83.29459,85.5036,87.95714,90.40982,92.61658,93.93693,94.79426],
      27.5=>[81.87334,82.74084,84.07717,86.31151,88.79602,91.28258,93.52227,94.86339,95.73464],
      28.5=>[82.61506,83.48951,84.83741,87.09346,89.60551,92.12313,94.39371,95.75464,96.63928],
      29.5=>[83.33473,84.21496,85.57273,87.84783,90.38477,92.93113,95.23082,96.61061,97.50808],
      30.5=>[84.02972,84.91494,86.28139,88.57362,91.13342,93.70662,96.03385,97.43164,98.34139],
      31.5=>[84.69837,85.58809,86.96242,89.27042,91.85154,94.45005,96.80343,98.2184,99.13993],
      32.5=>[85.33987,86.23379,87.6155,89.93835,92.53964,95.16218,97.54052,98.97193,99.90473],
      33.5=>[85.95413,86.85208,88.24089,90.57795,93.19854,95.84411,98.24636,99.69353,100.6372],
      34.5=>[86.54167,87.44359,88.83932,91.1902,93.82945,96.49721,98.92246,100.3848,101.3388],
      35.5=>[87.10349,88.00937,89.41196,91.77639,94.43382,97.12307,99.57056,101.0475,102.0116]}
    end
  end
  def getWeightData(gender)
    if gender.downcase=="male"
      {0=>[2.355451,2.526904,2.773802,3.150611,3.530203,3.879077,4.172493,4.340293,4.446488],
      0.5=>[2.799549,2.964656,3.20951,3.597396,4.003106,4.387423,4.718161,4.91013,5.032625],
      1.5=>[3.614688,3.774849,4.020561,4.428873,4.879525,5.327328,5.728153,5.967102,6.121929],
      2.5=>[4.342341,4.503255,4.754479,5.183378,5.672889,6.175598,6.638979,6.921119,7.10625],
      3.5=>[4.992898,5.157412,5.416803,5.866806,6.391392,6.942217,7.460702,7.781401,7.993878],
      4.5=>[5.575169,5.744752,6.013716,6.484969,7.041836,7.635323,8.202193,8.556813,8.793444],
      5.5=>[6.096775,6.272175,6.551379,7.043627,7.630425,8.262033,8.871384,9.255615,9.513307],
      6.5=>[6.56443,6.745993,7.035656,7.548346,8.162951,8.828786,9.475466,9.885436,10.16135],
      7.5=>[6.984123,7.171952,7.472021,8.004399,8.644832,9.34149,10.02101,10.45331,10.74492],
      8.5=>[7.361236,7.555287,7.865533,8.416719,9.08112,9.805593,10.51406,10.96574,11.27084],
      9.5=>[7.700624,7.900755,8.220839,8.789882,9.4765,10.22612,10.96017,11.42868,11.74538],
      10.5=>[8.006677,8.212684,8.542195,9.12811,9.835308,10.60772,11.36445,11.84763,12.17436],
      11.5=>[8.283365,8.495,8.833486,9.435279,10.16154,10.95466,11.7316,12.22766,12.56308],
      12.5=>[8.534275,8.751264,9.098246,9.714942,10.45885,11.27087,12.06595,12.5734,12.91645],
      13.5=>[8.762649,8.984701,9.339688,9.970338,10.73063,11.55996,12.37145,12.88911,13.23893],
      14.5=>[8.971407,9.198222,9.560722,10.20442,10.97992,11.82524,12.65175,13.17867,13.53462],
      15.5=>[9.16318,9.394454,9.763982,10.41986,11.20956,12.06973,12.91015,13.44564,13.80724],
      16.5=>[9.340328,9.575757,9.95184,10.6191,11.42207,12.29617,13.14969,13.69325,14.06019],
      17.5=>[9.504964,9.744251,10.12643,10.80433,11.61978,12.50708,13.37311,13.92444,14.29655],
      18.5=>[9.658975,9.90183,10.28968,10.97753,11.80478,12.70473,13.5829,14.14187,14.51909],
      19.5=>[9.804039,10.05019,10.4433,11.14047,11.97897,12.89117,13.78133,14.34795,14.73034],
      20.5=>[9.941645,10.19082,10.58881,11.29477,12.14404,13.06825,13.97042,14.54484,14.93256],
      21.5=>[10.07311,10.32507,10.72759,11.44185,12.30154,13.23765,14.15201,14.73448,15.12777],
      22.5=>[10.19957,10.4541,10.86084,11.58298,12.45283,13.40086,14.32772,14.91861,15.31777],
      23.5=>[10.32206,10.57895,10.98963,11.7193,12.59913,13.5592,14.499,15.09876,15.50418],
      24.5=>[10.44144,10.70051,11.1149,11.85182,12.74154,13.71386,14.66716,15.2763,15.68841],
      25.5=>[10.55847,10.81958,11.23747,11.98142,12.88102,13.8659,14.83332,15.45242,15.8717],
      26.5=>[10.6738,10.93681,11.35806,12.10889,13.01842,14.01623,14.99848,15.62819,16.05514],
      27.5=>[10.78798,11.0528,11.47728,12.23491,13.1545,14.16567,15.16351,15.8045,16.23967],
      28.5=>[10.90147,11.16803,11.59567,12.36007,13.2899,14.31493,15.32917,15.98214,16.42609],
      29.5=>[11.01466,11.28293,11.71368,12.4849,13.42519,14.46462,15.4961,16.16177,16.61508],
      30.5=>[11.12787,11.39782,11.8317,12.60983,13.56088,14.61527,15.66485,16.34395,16.8072],
      31.5=>[11.24135,11.513,11.95005,12.73523,13.69738,14.76732,15.83588,16.52915,17.00291],
      32.5=>[11.3553,11.62869,12.069,12.86144,13.83505,14.92117,16.00958,16.71773,17.2026],
      33.5=>[11.46988,11.74508,12.18875,12.9887,13.97418,15.07711,16.18624,16.91,17.40654],
      34.5=>[11.58521,11.8623,12.30948,13.11723,14.11503,15.23541,16.36612,17.10619,17.61495],
      35.5=>[11.70137,11.98046,12.43132,13.24721,14.2578,15.39628,16.5494,17.30646,17.82797]}
    elsif gender.downcase=="female"
      {0=>[2.414112,2.547905,2.747222,3.064865,3.399186,3.717519,3.992572,4.152637,4.254922],
      0.5=>[2.756917,2.894442,3.101767,3.437628,3.797528,4.145594,4.450126,4.628836,4.743582],
      1.5=>[3.402293,3.54761,3.770157,4.138994,4.544777,4.946766,5.305632,5.519169,5.657379],
      2.5=>[3.997806,4.150639,4.387042,4.78482,5.230584,5.680083,6.087641,6.332837,6.492574],
      3.5=>[4.547383,4.707123,4.955926,5.379141,5.859961,6.351512,6.80277,7.076723,7.256166],
      4.5=>[5.054539,5.220488,5.480295,5.925888,6.437588,6.966524,7.457119,7.757234,7.95473],
      5.5=>[5.5225,5.693974,5.96351,6.428828,6.96785,7.53018,8.056331,8.38033,8.594413],
      6.5=>[5.954272,6.130641,6.408775,6.891533,7.454854,8.047178,8.605636,8.951544,9.180938],
      7.5=>[6.352668,6.533373,6.819122,7.317373,7.902436,8.521877,9.109878,9.476009,9.719621],
      8.5=>[6.720328,6.904886,7.197414,7.709516,8.314178,8.958324,9.573546,9.95848,10.21539],
      9.5=>[7.059732,7.247736,7.546342,8.070932,8.693418,9.360271,10.00079,10.40335,10.6728],
      10.5=>[7.373212,7.564327,7.868436,8.4044,9.043262,9.731193,10.39545,10.8147,11.09607],
      11.5=>[7.662959,7.856916,8.166069,8.712513,9.366594,10.07431,10.76106,11.19625,11.48908],
      12.5=>[7.93103,8.127621,8.44146,8.997692,9.666089,10.39258,11.10089,11.55145,11.85539],
      13.5=>[8.179356,8.378425,8.696684,9.262185,9.944226,10.68874,11.41792,11.88348,12.19829],
      14.5=>[8.409744,8.611186,8.93368,9.508085,10.20329,10.96532,11.71491,12.19522,12.52078],
      15.5=>[8.623887,8.827638,9.154251,9.737329,10.44541,11.22463,11.99438,12.48934,12.82561],
      16.5=>[8.82337,9.029399,9.360079,9.951715,10.67251,11.46878,12.25862,12.76825,13.11527],
      17.5=>[9.009668,9.21798,9.552723,10.1529,10.88639,11.69972,12.50974,13.03415,13.39204],
      18.5=>[9.18416,9.394782,9.73363,10.34241,11.08868,11.91921,12.74964,13.28904,13.65799],
      19.5=>[9.348127,9.56111,9.90414,10.52167,11.2809,12.12887,12.98004,13.53473,13.91497],
      20.5=>[9.50276,9.71817,10.06549,10.69196,11.4644,12.33016,13.2025,13.77284,14.16467],
      21.5=>[9.649162,9.867081,10.21882,10.85446,11.64043,12.52439,13.41844,14.00484,14.40858],
      22.5=>[9.788355,10.00887,10.36518,11.01027,11.81014,12.71277,13.62911,14.23205,14.64807],
      23.5=>[9.921281,10.1445,10.50553,11.16037,11.97454,12.89636,13.83564,14.45561,14.88432],
      24.5=>[10.04881,10.27483,10.64076,11.30567,12.13456,13.07613,14.03902,14.67659,15.11839],
      25.5=>[10.17173,10.40066,10.77167,11.44697,12.29102,13.25293,14.24017,14.89587,15.35122],
      26.5=>[10.29079,10.52274,10.89899,11.58501,12.44469,13.42753,14.43984,15.11428,15.58363],
      27.5=>[10.40664,10.64171,11.02338,11.72047,12.59622,13.60059,14.63873,15.33249,15.81632],
      28.5=>[10.5199,10.75819,11.14545,11.85392,12.74621,13.77271,14.83743,15.55113,16.0499],
      29.5=>[10.63112,10.87273,11.26575,11.98592,12.89517,13.9444,15.03646,15.7707,16.28491],
      30.5=>[10.74078,10.98581,11.38474,12.11692,13.04357,14.11611,15.23626,15.99164,16.52176],
      31.5=>[10.84935,11.09789,11.50288,12.24735,13.19181,14.28822,15.43719,16.21432,16.76085],
      32.5=>[10.95722,11.20934,11.62054,12.37757,13.34023,14.46106,15.63957,16.43904,17.00245],
      33.5=>[11.06475,11.32054,11.73806,12.50791,13.48913,14.63491,15.84365,16.66605,17.24681],
      34.5=>[11.17225,11.43177,11.85574,12.63865,13.63877,14.80998,16.04963,16.89553,17.49412],
      35.5=>[11.28,11.54332,11.97384,12.77001,13.78937,14.98647,16.25767,17.12762,17.7445]}
    end
  end

  def findHeightDataByAge(age, gender, height)
    data = getHeightData(gender)
    data.keys.each do |key|
      if key > age
        index = 0
        return getPercentileWithIndex(getClosestValInArray((height/0.39370),data[key]))
        break
      end
    end
  end

  def findWeightDataByAge(age, gender, weight)
    data = getWeightData(gender)
    data.keys.each do |key|
      if key > age
        index = 0
        return getPercentileWithIndex(getClosestValInArray((weight*0.453592),data[key]))
        break
      end
    end
  end

  def getPercentileWithIndex(index)
    case index
      when 0
        return 3
      when 1
        return 5
      when 2
        return 10
      when 3
        return 25
      when 4
        return 50
      when 5
        return 75
      when 6
        return 90
      when 7
        return 95
      when 8
        return 97
      else
        return 0
      end
  end

  def getClosestValInArray(val,array)
    closest_val = 1000
    index = 0
    pos = 0
    array.each do |measurement|
      if (measurement-val).abs < closest_val
        closest_val = (measurement-val).abs
        pos = index
      end
      index = index + 1
    end
    return pos
  end

  # Instance methods
  # ========================================================
  def setHeightPercentile
    self.height_percentile = findHeightDataByAge(((self.happened_at.to_date - self.baby.birth.to_date).to_i)/31, self.baby.gender, self.height)
  end
  def setWeightPercentile
    self.weight_percentile = findWeightDataByAge(((self.happened_at.to_date - self.baby.birth.to_date).to_i)/31, self.baby.gender, self.weight)
  end


end
